# =============================================================================
# Bluejay Terminator - Production Docker Compose Configuration
# =============================================================================
# Production-ready configuration with optimized settings
#
# Usage:
#   docker-compose -f docker-compose.prod.yml up --build -d
#
# Note: This is primarily for local production testing.
# For AWS deployment, use the individual Dockerfile with App Runner or ECS.
# =============================================================================

# version: '3.8'  # Removed - obsolete in newer Docker Compose

services:
  # ---------------------------------------------------------------------------
  # Backend: Python Agent + Token Server (Production)
  # ---------------------------------------------------------------------------
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: bluejay-backend-prod
    ports:
      - "8080:8080"
    environment:
      # These should be injected from AWS Secrets Manager in production
      - LIVEKIT_URL=${LIVEKIT_URL}
      - LIVEKIT_API_KEY=${LIVEKIT_API_KEY}
      - LIVEKIT_API_SECRET=${LIVEKIT_API_SECRET}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - DEEPGRAM_API_KEY=${DEEPGRAM_API_KEY}
      - ELEVEN_API_KEY=${ELEVEN_API_KEY}
      - TAVILY_API_KEY=${TAVILY_API_KEY:-}
      # Production settings
      - ENABLE_NOISE_CANCELLATION=false
      - PYTHONUNBUFFERED=1
      - LOG_LEVEL=INFO
    volumes:
      - chroma_data:/app/chroma_db
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: always
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G
    networks:
      - bluejay-network

  # ---------------------------------------------------------------------------
  # Frontend: Production Build with Nginx
  # ---------------------------------------------------------------------------
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: production
    container_name: bluejay-frontend-prod
    ports:
      - "80:80"
    environment:
      - VITE_API_URL=${VITE_API_URL:-http://localhost:8080}
    depends_on:
      backend:
        condition: service_healthy
    restart: always
    networks:
      - bluejay-network

volumes:
  chroma_data:
    driver: local
    name: bluejay-chroma-data-prod

networks:
  bluejay-network:
    driver: bridge
    name: bluejay-network-prod

